<?php
class imgcode {
	public $inputname;
	function __construct() {
		$this->inputname=isset($GLOBALS['config']['imgcode'])?$GLOBALS['config']['imgcode']:'checkcode';
	}
	/*
	*中文验证码
	*/
	public function cncode() {
			Header("Content-type: image/PNG"); 
			$str=array (
			  0 => '的',
			  1 => '一',
			  2 => '是',
			  3 => '在',
			  4 => '了',
			  5 => '不',
			  6 => '和',
			  7 => '有',
			  8 => '大',
			  9 => '这',
			  10 => '主',
			  11 => '中',
			  12 => '人',
			  13 => '上',
			  14 => '为',
			  15 => '们',
			  16 => '地',
			  17 => '个',
			  18 => '用',
			  19 => '工',
			  20 => '时',
			  21 => '要',
			  22 => '动',
			  23 => '国',
			  24 => '产',
			  25 => '以',
			  26 => '我',
			  27 => '到',
			  28 => '他',
			  29 => '会',
			  30 => '作',
			  31 => '来',
			  32 => '分',
			  33 => '生',
			  34 => '对',
			  35 => '于',
			  36 => '学',
			  37 => '下',
			  38 => '级',
			  39 => '就',
			  40 => '年',
			  41 => '阶',
			  42 => '义',
			  43 => '发',
			  44 => '成',
			  45 => '部',
			  46 => '民',
			  47 => '可',
			  48 => '出',
			  49 => '能',
			  50 => '方',
			  51 => '进',
			  52 => '同',
			  53 => '行',
			  54 => '面',
			  55 => '说',
			  56 => '种',
			  57 => '过',
			  58 => '命',
			  59 => '度',
			  60 => '革',
			  61 => '而',
			  62 => '多',
			  63 => '子',
			  64 => '后',
			  65 => '自',
			  66 => '社',
			  67 => '加',
			  68 => '小',
			  69 => '机',
			  70 => '也',
			  71 => '经',
			  72 => '力',
			  73 => '线',
			  74 => '本',
			  75 => '电',
			  76 => '高',
			  77 => '量',
			  78 => '长',
			  79 => '党',
			  80 => '得',
			  81 => '实',
			  82 => '家',
			  83 => '定',
			  84 => '深',
			  85 => '法',
			  86 => '表',
			  87 => '着',
			  88 => '水',
			  89 => '理',
			  90 => '化',
			  91 => '争',
			  92 => '现',
			  93 => '所',
			  94 => '二',
			  95 => '起',
			  96 => '政',
			  97 => '三',
			  98 => '好',
			  99 => '十',
			  100 => '战',
			  101 => '无',
			  102 => '农',
			  103 => '使',
			  104 => '性',
			  105 => '前',
			  106 => '等',
			  107 => '反',
			  108 => '体',
			  109 => '合',
			  110 => '斗',
			  111 => '路',
			  112 => '图',
			  113 => '把',
			  114 => '结',
			  115 => '第',
			  116 => '里',
			  117 => '正',
			  118 => '新',
			  119 => '开',
			  120 => '论',
			  121 => '之',
			  122 => '物',
			  123 => '从',
			  124 => '当',
			  125 => '两',
			  126 => '些',
			  127 => '还',
			  128 => '天',
			  129 => '资',
			  130 => '事',
			  131 => '队',
			  132 => '批',
			  133 => '如',
			  134 => '应',
			  135 => '形',
			  136 => '想',
			  137 => '制',
			  138 => '心',
			  139 => '样',
			  140 => '干',
			  141 => '都',
			  142 => '向',
			  143 => '变',
			  144 => '关',
			  145 => '点',
			  146 => '育',
			  147 => '重',
			  148 => '其',
			  149 => '思',
			  150 => '与',
			  151 => '间',
			  152 => '内',
			  153 => '去',
			  154 => '因',
			  155 => '件',
			  156 => '日',
			  157 => '利',
			  158 => '相',
			  159 => '由',
			  160 => '压',
			  161 => '员',
			  162 => '气',
			  163 => '业',
			  164 => '代',
			  165 => '全',
			  166 => '组',
			  167 => '数',
			  168 => '果',
			  169 => '期',
			  170 => '导',
			  171 => '平',
			  172 => '各',
			  173 => '基',
			  174 => '或',
			  175 => '月',
			  176 => '毛',
			  177 => '然',
			  178 => '问',
			  179 => '比',
			  180 => '展',
			  181 => '那',
			  182 => '它',
			  183 => '最',
			  184 => '及',
			  185 => '外',
			  186 => '没',
			  187 => '看',
			  188 => '治',
			  189 => '提',
			  190 => '五',
			  191 => '解',
			  192 => '系',
			  193 => '林',
			  194 => '者',
			  195 => '米',
			  196 => '群',
			  197 => '头',
			  198 => '意',
			  199 => '只',
			  200 => '明',
			  201 => '四',
			  202 => '道',
			  203 => '马',
			  204 => '认',
			  205 => '次',
			  206 => '文',
			  207 => '通',
			  208 => '但',
			  209 => '条',
			  210 => '较',
			  211 => '克',
			  212 => '又',
			  213 => '公',
			  214 => '孔',
			  215 => '领',
			  216 => '军',
			  217 => '流',
			  218 => '入',
			  219 => '接',
			  220 => '席',
			  221 => '位',
			  222 => '情',
			  223 => '运',
			  224 => '器',
			  225 => '并',
			  226 => '飞',
			  227 => '原',
			  228 => '油',
			  229 => '放',
			  230 => '立',
			  231 => '题',
			  232 => '质',
			  233 => '指',
			  234 => '建',
			  235 => '区',
			  236 => '验',
			  237 => '活',
			  238 => '众',
			  239 => '很',
			  240 => '教',
			  241 => '决',
			  242 => '特',
			  243 => '此',
			  244 => '常',
			  245 => '石',
			  246 => '强',
			  247 => '极',
			  248 => '土',
			  249 => '少',
			  250 => '已',
			  251 => '根',
			  252 => '共',
			  253 => '直',
			  254 => '团',
			  255 => '统',
			  256 => '式',
			  257 => '转',
			  258 => '别',
			  259 => '造',
			  260 => '切',
			  261 => '九',
			  262 => '你',
			  263 => '取',
			  264 => '西',
			  265 => '持',
			  266 => '总',
			  267 => '料',
			  268 => '连',
			  269 => '任',
			  270 => '志',
			  271 => '观',
			  272 => '调',
			  273 => '七',
			  274 => '么',
			  275 => '山',
			  276 => '程',
			  277 => '百',
			  278 => '报',
			  279 => '更',
			  280 => '见',
			  281 => '必',
			  282 => '真',
			  283 => '保',
			  284 => '热',
			  285 => '委',
			  286 => '手',
			  287 => '改',
			  288 => '管',
			  289 => '处',
			  290 => '己',
			  291 => '将',
			  292 => '修',
			  293 => '支',
			  294 => '识',
			  295 => '病',
			  296 => '象',
			  297 => '几',
			  298 => '先',
			  299 => '老',
			  300 => '光',
			  301 => '专',
			  302 => '什',
			  303 => '六',
			  304 => '型',
			  305 => '具',
			  306 => '示',
			  307 => '复',
			  308 => '安',
			  309 => '带',
			  310 => '每',
			  311 => '东',
			  312 => '增',
			  313 => '则',
			  314 => '完',
			  315 => '风',
			  316 => '回',
			  317 => '南',
			  318 => '广',
			  319 => '劳',
			  320 => '轮',
			  321 => '科',
			  322 => '北',
			  323 => '打',
			  324 => '积',
			  325 => '车',
			  326 => '计',
			  327 => '给',
			  328 => '节',
			  329 => '做',
			  330 => '务',
			  331 => '被',
			  332 => '整',
			  333 => '联',
			  334 => '步',
			  335 => '类',
			  336 => '集',
			  337 => '号',
			  338 => '列',
			  339 => '温',
			  340 => '装',
			  341 => '即',
			  342 => '毫',
			  343 => '知',
			  344 => '轴',
			  345 => '研',
			  346 => '单',
			  347 => '色',
			  348 => '坚',
			  349 => '据',
			  350 => '速',
			  351 => '防',
			  352 => '史',
			  353 => '拉',
			  354 => '世',
			  355 => '设',
			  356 => '达',
			  357 => '尔',
			  358 => '场',
			  359 => '织',
			  360 => '历',
			  361 => '花',
			  362 => '受',
			  363 => '求',
			  364 => '传',
			  365 => '口',
			  366 => '断',
			  367 => '况',
			  368 => '采',
			  369 => '精',
			  370 => '金',
			  371 => '界',
			  372 => '品',
			  373 => '判',
			  374 => '参',
			  375 => '层',
			  376 => '止',
			  377 => '边',
			  378 => '清',
			  379 => '至',
			  380 => '万',
			  381 => '确',
			  382 => '究',
			  383 => '书',
			  384 => '术',
			  385 => '状',
			  386 => '厂',
			  387 => '须',
			  388 => '离',
			  389 => '再',
			  390 => '目',
			  391 => '海',
			  392 => '交',
			  393 => '权',
			  394 => '且',
			  395 => '儿',
			  396 => '青',
			  397 => '才',
			  398 => '证',
			  399 => '低',
			  400 => '越',
			  401 => '际',
			  402 => '八',
			  403 => '试',
			  404 => '规',
			  405 => '斯',
			  406 => '近',
			  407 => '注',
			  408 => '办',
			  409 => '布',
			  410 => '门',
			  411 => '铁',
			  412 => '需',
			  413 => '走',
			  414 => '议',
			  415 => '县',
			  416 => '兵',
			  417 => '固',
			  418 => '除',
			  419 => '般',
			  420 => '引',
			  421 => '齿',
			  422 => '千',
			  423 => '胜',
			  424 => '细',
			  425 => '影',
			  426 => '济',
			  427 => '白',
			  428 => '格',
			  429 => '效',
			  430 => '置',
			  431 => '推',
			  432 => '空',
			  433 => '配',
			  434 => '刀',
			  435 => '叶',
			  436 => '率',
			  437 => '述',
			  438 => '今',
			  439 => '选',
			  440 => '养',
			  441 => '德',
			  442 => '话',
			  443 => '查',
			  444 => '差',
			  445 => '半',
			  446 => '敌',
			  447 => '始',
			  448 => '片',
			  449 => '施',
			  450 => '响',
			  451 => '收',
			  452 => '华',
			  453 => '觉',
			  454 => '备',
			  455 => '名',
			  456 => '红',
			  457 => '续',
			  458 => '均',
			  459 => '药',
			  460 => '标',
			  461 => '记',
			  462 => '难',
			  463 => '存',
			  464 => '测',
			  465 => '士',
			  466 => '身',
			  467 => '紧',
			  468 => '液',
			  469 => '派',
			  470 => '准',
			  471 => '斤',
			  472 => '角',
			  473 => '降',
			  474 => '维',
			  475 => '板',
			  476 => '许',
			  477 => '破',
			  478 => '述',
			  479 => '技',
			  480 => '消',
			  481 => '底',
			  482 => '床',
			  483 => '田',
			  484 => '势',
			  485 => '端',
			  486 => '感',
			  487 => '往',
			  488 => '神',
			  489 => '便',
			  490 => '贺',
			  491 => '村',
			  492 => '构',
			  493 => '照',
			  494 => '容',
			  495 => '非',
			  496 => '搞',
			  497 => '亚',
			  498 => '磨',
			  499 => '族',
			  500 => '火',
			  501 => '段',
			  502 => '算',
			  503 => '适',
			  504 => '讲',
			  505 => '按',
			  506 => '值',
			  507 => '美',
			  508 => '态',
			  509 => '黄',
			  510 => '易',
			  511 => '彪',
			  512 => '服',
			  513 => '早',
			  514 => '班',
			  515 => '麦',
			  516 => '削',
			  517 => '信',
			  518 => '排',
			  519 => '台',
			  520 => '声',
			  521 => '该',
			  522 => '击',
			  523 => '素',
			  524 => '张',
			  525 => '密',
			  526 => '害',
			  527 => '侯',
			  528 => '草',
			  529 => '何',
			  530 => '树',
			  531 => '肥',
			  532 => '继',
			  533 => '右',
			  534 => '属',
			  535 => '市',
			  536 => '严',
			  537 => '径',
			  538 => '螺',
			  539 => '检',
			  540 => '左',
			  541 => '页',
			  542 => '抗',
			  543 => '苏',
			  544 => '显',
			  545 => '苦',
			  546 => '英',
			  547 => '快',
			  548 => '称',
			  549 => '坏',
			  550 => '移',
			  551 => '约',
			  552 => '巴',
			  553 => '材',
			  554 => '省',
			  555 => '黑',
			  556 => '武',
			  557 => '培',
			  558 => '著',
			  559 => '河',
			  560 => '帝',
			  561 => '仅',
			  562 => '针',
			  563 => '怎',
			  564 => '植',
			  565 => '京',
			  566 => '助',
			  567 => '升',
			  568 => '王',
			  569 => '眼',
			  570 => '她',
			  571 => '抓',
			  572 => '含',
			  573 => '苗',
			  574 => '副',
			  575 => '杂',
			  576 => '普',
			  577 => '谈',
			  578 => '围',
			  579 => '食',
			  580 => '射',
			  581 => '源',
			  582 => '例',
			  583 => '致',
			  584 => '酸',
			  585 => '旧',
			  586 => '却',
			  587 => '充',
			  588 => '足',
			  589 => '短',
			  590 => '划',
			  591 => '剂',
			  592 => '宣',
			  593 => '环',
			  594 => '落',
			  595 => '首',
			  596 => '尺',
			  597 => '波',
			  598 => '承',
			  599 => '粉',
			  600 => '践',
			  601 => '府',
			  602 => '鱼',
			  603 => '随',
			  604 => '考',
			  605 => '刻',
			  606 => '靠',
			  607 => '够',
			  608 => '满',
			  609 => '夫',
			  610 => '失',
			  611 => '包',
			  612 => '住',
			  613 => '促',
			  614 => '枝',
			  615 => '局',
			  616 => '菌',
			  617 => '杆',
			  618 => '周',
			  619 => '护',
			  620 => '岩',
			  621 => '师',
			  622 => '举',
			  623 => '曲',
			  624 => '春',
			  625 => '元',
			  626 => '超',
			  627 => '负',
			  628 => '砂',
			  629 => '封',
			  630 => '换',
			  631 => '太',
			  632 => '模',
			  633 => '贫',
			  634 => '减',
			  635 => '阳',
			  636 => '扬',
			  637 => '江',
			  638 => '析',
			  639 => '亩',
			  640 => '木',
			  641 => '言',
			  642 => '球',
			  643 => '朝',
			  644 => '医',
			  645 => '校',
			  646 => '古',
			  647 => '呢',
			  648 => '稻',
			  649 => '宋',
			  650 => '听',
			  651 => '唯',
			  652 => '输',
			  653 => '滑',
			  654 => '站',
			  655 => '另',
			  656 => '卫',
			  657 => '字',
			  658 => '鼓',
			  659 => '刚',
			  660 => '写',
			  661 => '刘',
			  662 => '微',
			  663 => '略',
			  664 => '范',
			  665 => '供',
			  666 => '阿',
			  667 => '块',
			  668 => '某',
			  669 => '功',
			  670 => '套',
			  671 => '友',
			  672 => '限',
			  673 => '项',
			  674 => '余',
			  675 => '倒',
			  676 => '卷',
			  677 => '创',
			  678 => '律',
			  679 => '雨',
			  680 => '让',
			  681 => '骨',
			  682 => '远',
			  683 => '帮',
			  684 => '初'
			);
			$image_x=140;
			$image_y=80;
			$im = imagecreate($image_x,$image_y); 
			$fnt = P("frameworkpath")."config/mask.TTF"; //显示的字体样式
			$white=imagecolorallocate($im,rand(100,160),rand(100,160),rand(100,160));
			imagearc($im, 150, 8, 20, 20, 75, 170, $white);
			imagearc($im, 180, 7,50, 30, 75, 175, $white);
			imageline($im,20,20,180,30,$white);
			imageline($im,20,18,170,50,$white);
			imageline($im,25,50,80,50,$white);
			$noise_num=50;
			$line_num=80;

			$font_color[0]=imagecolorallocate($im,0xa5,0x20,0xb5);
			$font_color[1]=imagecolorallocate($im,0x60,0xb0,0xc5);
			$font_color[2]=imagecolorallocate($im,0x00,0xe0,0x70);
			$font_color[3]=imagecolorallocate($im,0x90,0x00,0x70);

			$rectangle_color=imagecolorallocate($im,0x80,0x80,0x80);
			$noise_color=imagecolorallocate($im,0x00,0x00,0x00);

			$line_color=imagecolorallocate($im,0x80,0x80,0x40);

			$n=rand(0,3);
			for($i=0;$i<$noise_num;$i++)
			{
			  imagefilledellipse($im, mt_rand(0,$image_x), mt_rand(0,$image_y), rand(3,8),rand(3,8),$font_color[$n]);
			  imageline($im,mt_rand(0,$image_x),mt_rand(0,$image_y),mt_rand(0,$image_x),mt_rand(0,$image_y),$line_color);
			}
			$s='';
			for($i=0;$i<3;$i++)
			{
			 $n=rand(10,400);
			 $str3=$str[intval($n)];
			 $s.=$str3;
			 $fix=rand(0,1)?'-':'';
			 imagettftext($im,rand(22,26),$fix.rand(20,50),40*$i+20,rand(30,50),$font_color[rand(0,2)], $fnt,$str3);
			}
			for($i=0;$i<20;$i++)
			imageline($im,mt_rand(0,$image_x),mt_rand(0,$image_y),mt_rand(0,$image_x),mt_rand(0,$image_y),$font_color[rand(0,2)]);
			$_SESSION['verifier']=$s;
			ImagePNG($im); 
			ImageDestroy($im);
  }
  /*
  *英文验证码
  */
 public function encode() {
		Header("Content-type: image/PNG"); 
		$str=array (
		  0 => 'A',
		  1 => 'B',
		  2 => 'C',
		  3 => 'D',
		  4 => 'E',
		  5 => 'F',
		  6 => 'G',
		  7 => 'H',
		  8 => 'K',
		  9 => 'N',
		  10 => 'M',
		  11 => 'P',
		  12 => 'R',
		  13 => 'S',
		  14 => 'T',
		  15 => 'U',
		  16 => 'V',
		  17 => 'W',
		  18 => 'X',
		  19 => '2',
		  20 => '3',
		  21 => '4',
		  22 => '5',
		  23 => '6',
		  24 => '7',
		  25 => '8',
		  26 => '9'
		);
		$image_x=140;
		$image_y=80;
		$im = imagecreate($image_x,$image_y); 
		$fnt = P("frameworkpath")."config/mask.TTF"; //显示的字体样式
		$white=imagecolorallocate($im,rand(100,160),rand(100,160),rand(100,160));
		imagearc($im, 150, 8, 20, 20, 75, 170, $white);
		imagearc($im, 180, 7,50, 30, 75, 175, $white);
		imageline($im,20,20,180,30,$white);
		imageline($im,20,18,170,50,$white);
		imageline($im,25,50,80,50,$white);
		$noise_num=50;
		$line_num=80;

		$font_color[0]=imagecolorallocate($im,0xa5,0x20,0xb5);
		$font_color[1]=imagecolorallocate($im,0x60,0xb0,0xc5);
		$font_color[2]=imagecolorallocate($im,0x00,0xe0,0x70);
		$font_color[3]=imagecolorallocate($im,0x90,0x00,0x70);

		$rectangle_color=imagecolorallocate($im,0x80,0x80,0x80);
		$noise_color=imagecolorallocate($im,0x00,0x00,0x00);

		$line_color=imagecolorallocate($im,0x80,0x80,0x40);

		$n=rand(0,3);
		for($i=0;$i<$noise_num;$i++)
		{
		  imagefilledellipse($im, mt_rand(0,$image_x), mt_rand(0,$image_y), rand(3,8),rand(3,8),$font_color[$n]);
		  imageline($im,mt_rand(0,$image_x),mt_rand(0,$image_y),mt_rand(0,$image_x),mt_rand(0,$image_y),$line_color);
		}
		$s='';
		for($i=0;$i<5;$i++)
		{
		 $n=rand(0,26);
		 $str3=$str[intval($n)];
		 $s.=$str3;
		 $fix=rand(0,1)?'-':'';
		 imagettftext($im,rand(24,32),$fix.rand(10,30),25*$i+10,rand(30,50),$font_color[rand(0,2)], $fnt,$str3);
		}
		$_SESSION['verifier']=$s;
		ImagePNG($im); 
		ImageDestroy($im);
  }
  public function getInputHTML() {
  	return '<input name="'.$this->inputname.'" id="'.$this->inputname.'" />';
  }
  public function getImgHTML($url) {
  	return '<img src="'.$url.'" onclick="this.src=this.alt+\'?\'+Math.random();" alt="'.$url.'"/>';
  }
  public function getInputname() {
  	  Return $this->inputname;
  }
  public function checkcode($code) {
	  if(empty($code)) $code=$_POST[$this->inputname];
  	  if(empty($_SESSION['verifier'])) Return false;
      if(empty($code)) { unset($_SESSION['verifier']);  Return false; }
	  if($code==$_SESSION['verifier']){
		  unset($_SESSION['verifier']);
		  Return true;
	  }else{
	    unset($_SESSION['verifier']);
		 Return false;
	  }
  }
} 
?>